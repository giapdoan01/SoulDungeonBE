{
  "version": 3,
  "sources": ["../../src/utils/Cloud.ts"],
  "sourcesContent": ["import os from 'os';\nimport fs from 'fs';\nimport net from 'net';\n\nimport { logger } from '../Logger.ts';\nimport type { Presence } from '../presence/Presence.ts';\nimport type { MatchMakerDriver } from '../matchmaker/LocalDriver/LocalDriver.ts';\nimport { LocalDriver } from '../matchmaker/LocalDriver/LocalDriver.ts';\nimport { LocalPresence } from '../presence/LocalPresence.ts';\n\n// Lazy-load Redis packages (optional dependencies)\nconst RedisDriver = import('@colyseus/redis-driver'); RedisDriver.catch(() => {});\nconst RedisPresence = import('@colyseus/redis-presence'); RedisPresence.catch(() => {});\n\n/**\n * Check if running under Colyseus Cloud environment.\n */\nexport function isColyseusCloud(): boolean {\n  return process.env.COLYSEUS_CLOUD !== undefined;\n}\n\n/**\n * Determine whether Redis configuration should be used.\n * Returns true if:\n * - Running on a multi-core machine (> 1 CPU)\n * - Or REDIS_URI environment variable is set\n */\nexport function shouldUseRedisConfig(): boolean {\n  return (os.cpus().length > 1) || (process.env.REDIS_URI !== undefined);\n}\n\n/**\n * Get the effective port for Colyseus Cloud.\n * On Colyseus Cloud, port 2567 is enforced, adjusted for NODE_APP_INSTANCE.\n *\n * @param requestedPort - The originally requested port\n * @returns The effective port number\n */\nexport function getCloudPort(requestedPort: number): number {\n  // Force 2567 port on Colyseus Cloud\n  let port = 2567;\n\n  // Handle multiple processes (plays nicely with pm2)\n  const processNumber = Number(process.env.NODE_APP_INSTANCE || \"0\");\n  port += processNumber;\n\n  return port;\n}\n\n/**\n * Get the Unix socket path for Colyseus Cloud.\n *\n * @param port - The port number\n * @returns The socket path\n */\nexport function getCloudSocketPath(port: number): string {\n  return `/run/colyseus/${port}.sock`;\n}\n\n/**\n * Check if a socket file is active and remove it if it's not.\n * Fixes \"EADDRINUSE\" issue when restarting the server.\n *\n * @param sockFilePath - Path to the socket file\n */\nexport function checkInactiveSocketFile(sockFilePath: string): Promise<boolean> {\n  return new Promise((resolve, reject) => {\n    const client = net.createConnection({ path: sockFilePath })\n      .on('connect', () => {\n        // socket file is active, close the connection\n        client.end();\n        reject(new Error(`EADDRINUSE: Already listening on '${sockFilePath}'`));\n      })\n      .on('error', () => {\n        // socket file is inactive, remove it\n        fs.unlink(sockFilePath, () => resolve(true));\n      });\n  });\n}\n\nexport interface CloudConfig {\n  driver: MatchMakerDriver;\n  presence: Presence;\n  publicAddress: string;\n}\n\n/**\n * Get cloud configuration for Colyseus Cloud environment.\n * Automatically initializes Redis driver/presence when appropriate.\n *\n * @param port - The port number the server is running on\n * @param currentDriver - Existing driver instance (if any)\n * @param currentPresence - Existing presence instance (if any)\n * @returns Cloud configuration or null if not applicable\n */\nexport async function getCloudConfig(\n  port: number,\n  currentDriver?: MatchMakerDriver,\n  currentPresence?: Presence,\n): Promise<CloudConfig | null> {\n  if (!isColyseusCloud()) {\n    return null;\n  }\n\n  if (!shouldUseRedisConfig()) {\n    return null;\n  }\n\n  let driver = currentDriver;\n  let presence = currentPresence;\n  const publicAddress = process.env.SUBDOMAIN + \".\" + process.env.SERVER_NAME + \"/\" + port;\n\n  // Only initialize Redis driver if no driver was provided or it's a LocalDriver\n  const needsRedisDriver = !driver || driver instanceof LocalDriver;\n  // Only initialize Redis presence if no presence was provided or it's a LocalPresence\n  const needsRedisPresence = !presence || presence instanceof LocalPresence;\n\n  if (needsRedisDriver) {\n    try {\n      const module = await RedisDriver;\n      driver = new module.RedisDriver(process.env.REDIS_URI);\n    } catch (e) {\n      logger.error(e);\n      logger.warn(\"\");\n      logger.warn(\"\u274C Could not initialize RedisDriver for Colyseus Cloud.\");\n      logger.warn(\"\uD83D\uDC49 npm install --save @colyseus/redis-driver\");\n      logger.warn(\"\");\n    }\n  }\n\n  if (needsRedisPresence) {\n    try {\n      const module = await RedisPresence;\n      presence = new module.RedisPresence(process.env.REDIS_URI);\n    } catch (e) {\n      logger.error(e);\n      logger.warn(\"\");\n      logger.warn(\"\u274C Could not initialize RedisPresence for Colyseus Cloud.\");\n      logger.warn(\"\uD83D\uDC49 npm install --save @colyseus/redis-presence\");\n      logger.warn(\"\");\n    }\n  }\n\n  return { driver, presence, publicAddress };\n}\n"],
  "mappings": ";AAAA,OAAO,QAAQ;AACf,OAAO,QAAQ;AACf,OAAO,SAAS;AAEhB,SAAS,cAAc;AAGvB,SAAS,mBAAmB;AAC5B,SAAS,qBAAqB;AAG9B,IAAM,cAAc,OAAO,wBAAwB;AAAG,YAAY,MAAM,MAAM;AAAC,CAAC;AAChF,IAAM,gBAAgB,OAAO,0BAA0B;AAAG,cAAc,MAAM,MAAM;AAAC,CAAC;AAK/E,SAAS,kBAA2B;AACzC,SAAO,QAAQ,IAAI,mBAAmB;AACxC;AAQO,SAAS,uBAAgC;AAC9C,SAAQ,GAAG,KAAK,EAAE,SAAS,KAAO,QAAQ,IAAI,cAAc;AAC9D;AASO,SAAS,aAAa,eAA+B;AAE1D,MAAI,OAAO;AAGX,QAAM,gBAAgB,OAAO,QAAQ,IAAI,qBAAqB,GAAG;AACjE,UAAQ;AAER,SAAO;AACT;AAQO,SAAS,mBAAmB,MAAsB;AACvD,SAAO,iBAAiB,IAAI;AAC9B;AAQO,SAAS,wBAAwB,cAAwC;AAC9E,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAM,SAAS,IAAI,iBAAiB,EAAE,MAAM,aAAa,CAAC,EACvD,GAAG,WAAW,MAAM;AAEnB,aAAO,IAAI;AACX,aAAO,IAAI,MAAM,qCAAqC,YAAY,GAAG,CAAC;AAAA,IACxE,CAAC,EACA,GAAG,SAAS,MAAM;AAEjB,SAAG,OAAO,cAAc,MAAM,QAAQ,IAAI,CAAC;AAAA,IAC7C,CAAC;AAAA,EACL,CAAC;AACH;AAiBA,eAAsB,eACpB,MACA,eACA,iBAC6B;AAC7B,MAAI,CAAC,gBAAgB,GAAG;AACtB,WAAO;AAAA,EACT;AAEA,MAAI,CAAC,qBAAqB,GAAG;AAC3B,WAAO;AAAA,EACT;AAEA,MAAI,SAAS;AACb,MAAI,WAAW;AACf,QAAM,gBAAgB,QAAQ,IAAI,YAAY,MAAM,QAAQ,IAAI,cAAc,MAAM;AAGpF,QAAM,mBAAmB,CAAC,UAAU,kBAAkB;AAEtD,QAAM,qBAAqB,CAAC,YAAY,oBAAoB;AAE5D,MAAI,kBAAkB;AACpB,QAAI;AACF,YAAM,SAAS,MAAM;AACrB,eAAS,IAAI,OAAO,YAAY,QAAQ,IAAI,SAAS;AAAA,IACvD,SAAS,GAAG;AACV,aAAO,MAAM,CAAC;AACd,aAAO,KAAK,EAAE;AACd,aAAO,KAAK,6DAAwD;AACpE,aAAO,KAAK,qDAA8C;AAC1D,aAAO,KAAK,EAAE;AAAA,IAChB;AAAA,EACF;AAEA,MAAI,oBAAoB;AACtB,QAAI;AACF,YAAM,SAAS,MAAM;AACrB,iBAAW,IAAI,OAAO,cAAc,QAAQ,IAAI,SAAS;AAAA,IAC3D,SAAS,GAAG;AACV,aAAO,MAAM,CAAC;AACd,aAAO,KAAK,EAAE;AACd,aAAO,KAAK,+DAA0D;AACtE,aAAO,KAAK,uDAAgD;AAC5D,aAAO,KAAK,EAAE;AAAA,IAChB;AAAA,EACF;AAEA,SAAO,EAAE,QAAQ,UAAU,cAAc;AAC3C;",
  "names": []
}
